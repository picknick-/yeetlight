<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Yeetlight</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <div id="app">
      <div class="section">
        <div class="columns is-multiline">
          <bulb v-for="bulb in config.bulbs"
                :key="bulb.addr"
                :addr="bulb.addr"
                :name="bulb.name"
                class="column"></bulb>
        </div>
      </div>
    </div>
  </body>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">

  <template id="bulb-template">
    <div class="bulb">
      <div class="center">
        <div>{{ name || addr }}</div>
        <div>
          <button class="button"
                  :class="power === true ? 'is-primary' : ''"
                  @click="power = true">ON</button>
          <button class="button"
                  :class="power === false ? 'is-primary' : ''"
                  @click="power = false">OFF</button>
        </div>
        <table class="fading"
               :class="{ disabled: !power }">
          <tr class="brightness">
            <td>Brightness</td>
            <td>
              <input type="range"
                     min="0" max="100"
                     step="5"
                     name="brightness"
                     value="brightness"
                     v-model="rawBrightness"
                     @change="brightness = rawBrightness"
              />
            </td>
            <td>{{ brightness }}%</td>
          </tr>
          <tr class="temperature">
            <td>Temperature</td>
            <td>
              <input type="range"
                     min="1700" max="6500"
                     step="100"
                     name="temperature"
                     value="temperature"
                     v-model="rawTemperature"
                     @change="temperature = rawTemperature"
              />
            </td>
            <td>{{ temperature }}K</td>
          </tr>
        </table>
      </div>
    </div>
  </template>

  <script>
   'use strict';

   Vue.component('bulb', {
     props: ['addr', 'name'],
     template: "#bulb-template",
     data() {
       return {
         rawPower: undefined,
         rawBrightness: undefined,
         rawTemperature: undefined
       }
     },
     computed: {
       power: {
         get() {
           return this.rawPower
         },
         set(newValue) {
           switch (newValue) {
             case true:
             case false:
               this.$http.post(
                 "/"
                 + (newValue ? "on" : "off")
                 + "?bulb=" + this.addr
               ).then(res => {
                 this.rawPower = newValue
               })
             default:
               this.rawPower = undefined
           }
         }
       },
       temperature: {
         get() {
           return this.rawTemperature
         },
         set(newValue) {
           if (this.power !== true) {
             this.power = true
           }
           this.$http.post(
             "/temperature?bulb=" + this.addr + "&temperature=" + newValue
           )
         }
       },
       brightness: {
         get() {
           return this.rawBrightness
         },
         set(newValue) {
           if (this.power !== true) {
             this.power = true
           }
           this.$http.post(
             "/brightness?bulb=" + this.addr + "&brightness=" + newValue
           )
         }
       }
     },
     mounted() {
       this.$http.get("/info?bulb=" + this.addr).then(res => {
         const info = res.body
         this.rawBrightness = parseInt(info.bright)
         this.rawTemperature = parseInt(info.ct)
         this.rawPower = (info.power === "on")
       })
     }
   });

   var app = new Vue({
     el: '#app',
     methods: {},
     data() {
       return {
         config: {}
       }
     },
     created() {
       this.$http.get("/config.json").then(res => {
         this.config = res.body
       })
     },
   })
  </script>
</html>
