<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Yeetlight</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <div id="app">
      <div class="section">
        <div class="columns is-multiline">
          <bulb v-for="bulb, name in bulbs"
                :key="name"
                :addr="bulb.addr || name"
                :name="name"
                class="column"></bulb>
        </div>
      </div>
    </div>
  </body>

  <script src="js/vue.js"></script>
  <script src="js/axios.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/bulma.min.css">

  <template id="bulb-template">
    <div class="bulb">
      <div class="center">
        <div>{{ name }}</div>
        <div>
          <button class="button"
                  :class="power === true ? 'is-primary' : ''"
                  @click="power = true">ON</button>
          <button class="button"
                  :class="power === false ? 'is-primary' : ''"
                  @click="power = false">OFF</button>
        </div>
        <table class="fading"
               :class="{ disabled: !power }">
          <tr class="brightness">
            <td>Brightness</td>
            <td>
              <input type="range"
                     min="0" max="100"
                     step="5"
                     name="brightness"
                     value="brightness"
                     v-model="rawBrightness"
                     @change="brightness = rawBrightness"
              />
            </td>
            <td>{{ brightness }}%</td>
          </tr>
          <tr class="temperature">
            <td>Temperature</td>
            <td>
              <input type="range"
                     min="1700" max="6500"
                     step="100"
                     name="temperature"
                     value="temperature"
                     v-model="rawTemperature"
                     @change="temperature = rawTemperature"
              />
            </td>
            <td>{{ temperature }}K</td>
          </tr>
        </table>
      </div>
    </div>
  </template>

  <script>
   'use strict';

   axios.get("/config.json").then(res => {
     const config = res.data

     Vue.component('bulb', {
       props: ['addr', 'name'],
       template: "#bulb-template",
       data() {
         return {
           rawPower: undefined,
           rawBrightness: undefined,
           rawTemperature: undefined
         }
       },
       computed: {
         power: {
           get() {
             return this.rawPower
           },
           set(newValue) {
             switch (newValue) {
               case true:
               case false:
                 axios.post(
                   "/"
                   + (newValue ? "on" : "off")
                   + "?bulb=" + this.addr
                 ).then(res => {
                   this.rawPower = newValue
                 })
               default:
                 this.rawPower = undefined
             }
           }
         },
         temperature: {
           get() {
             return this.rawTemperature
           },
           set(newValue) {
             if (this.power !== true) {
               this.power = true
             }
             axios.post(
               "/temperature?bulb=" + this.addr + "&temperature=" + newValue
             )
           }
         },
         brightness: {
           get() {
             return this.rawBrightness
           },
           set(newValue) {
             if (this.power !== true) {
               this.power = true
             }
             axios.post(
               "/brightness?bulb=" + this.addr + "&brightness=" + newValue
             )
           }
         }
       },
       mounted() {
         axios.get("/info?bulb=" + this.addr).then(res => {
           const info = res.data
           this.rawBrightness = parseInt(info.bright)
           this.rawTemperature = parseInt(info.ct)
           this.rawPower = (info.power === "on")
         })
       }
     });

     var app = new Vue({
       el: '#app',
       methods: {},
       data() {
         return {
           bulbs: config.bulbs
         }
       }
     })
   })
  </script>
</html>
